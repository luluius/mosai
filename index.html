<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mosa√Øque - Quand tout s'imbrique</title>
    <style>
        /* =========================================
           VARIABLES ET RESET
        ========================================= */
        :root {
            --bg-color: #f8f9fa;
            --header-bg: #4a4a4a;
            --text-color: #333;
            --primary-green: #2e7d32;
            --light-green: #e8f5e9;
            --font-main: 'Helvetica Neue', Arial, sans-serif;
            --font-title: 'Georgia', serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease, background-image 0.3s ease;
        }

        /* =========================================
           HEADER & NAVIGATION
        ========================================= */
        header {
            background-color: var(--header-bg);
            color: white;
            padding: 15px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            transition: background-color 0.3s ease;
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            background-color: var(--primary-green);
            color: white;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 20px;
            border-radius: 4px;
        }

        .logo-text h1 {
            font-size: 18px;
            margin: 0;
            letter-spacing: 1px;
        }
        .logo-text p {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            opacity: 0.8;
        }

        /* Ic√¥ne Hamburger (cach√©e sur desktop) */
        .hamburger {
            display: none;
            font-size: 28px;
            cursor: pointer;
            color: white;
            user-select: none;
        }

        nav ul {
            list-style: none;
            display: flex;
            gap: 25px;
            align-items: center;
        }

        nav a {
            color: white;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: color 0.2s;
        }

        nav a:hover, nav a.active {
            color: #a5d6a7;
        }

        .btn-connexion {
            background-color: var(--primary-green);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        .btn-connexion:hover {
            background-color: #1b5e20;
        }

        /* =========================================
           MAIN CONTAINER & VIEWS
        ========================================= */
        main {
            flex: 1;
            padding: 40px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .view-section {
            display: none; 
            animation: fadeIn 0.5s ease;
        }
        .view-section.active {
            display: block; 
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* =========================================
           PAGE ACCUEIL
        ========================================= */
        .accueil-layout {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 50px;
            gap: 50px;
        }

        .accueil-text {
            flex: 1;
        }

        .badge {
            background-color: var(--light-green);
            color: var(--primary-green);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 20px;
        }

        .accueil-title {
            font-family: var(--font-title);
            font-size: 80px;
            font-style: italic;
            margin-bottom: 20px;
            color: #1a1a1a;
        }

        .accueil-desc {
            font-size: 18px;
            line-height: 1.6;
            color: #666;
            max-width: 80%;
        }

        .accueil-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .grid-item {
            width: 100%;
            aspect-ratio: 1 / 1;
            border-radius: 12px;
            background-color: #ccc;
            background-size: cover;
            background-position: center;
            position: relative; 
        }

        .c1 { background-color: #bcaaa4; }
        .c2 { background-color: #e6b89c; }
        .c3 { background-color: #ffcc80; }
        .c4 { background-color: #d4a32b; }
        .c5 { background-color: #c5c2a1; }
        .c6 { background-color: #cddc39; }
        .c7 { background-color: #8da96b; }
        .c8 { background-color: #81c784; }
        .c9 { background-color: #b2dfdb; }

        /* =========================================
           PAGE PUBLICATIONS & MESSAGES
        ========================================= */
        /* Onglets pour mobile cach√©s sur desktop */
        .mobile-pub-tabs {
            display: none;
        }
        
        .publications-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
        }
        .col-title {
            font-size: 24px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--primary-green);
            padding-bottom: 10px;
        }
        .post-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            position: relative; 
        }
        .post-card img, .post-card video {
            width: 100%;
            border-radius: 8px;
            margin-top: 10px;
        }

        /* =========================================
           PAGE A PROPOS & CONTACT
        ========================================= */
        .apropos-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .profile-pic {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            background-color: #ccc;
            margin-bottom: 20px;
            border: 4px solid var(--primary-green);
        }
        
        .social-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .social-btn {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 25px;
            color: white !important;
            text-decoration: none !important;
            font-weight: bold;
            font-size: 14px;
            transition: transform 0.2s, opacity 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .social-btn:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }
        .btn-insta { background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); }
        .btn-fb { background: #1877f2; }
        .btn-tiktok { background: #000000; }

        .contact-form {
            margin-top: 40px;
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .contact-form input, .contact-form textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .contact-form button {
            background-color: var(--primary-green);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 5px;
            cursor: pointer;
        }

        /* =========================================
           MODE ADMIN OUTILS & SUPPRESSION
        ========================================= */
        .admin-tools {
            display: none;
            background: #ffe082;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 14px;
            border: 1px solid #ffb300;
        }
        body.is-admin .admin-tools {
            display: block;
        }
        .edit-btn {
            display: none;
            background: #333;
            color: white;
            border: none;
            padding: 5px 10px;
            font-size: 10px;
            border-radius: 3px;
            cursor: pointer;
            margin-top: 5px;
        }
        body.is-admin .edit-btn {
            display: inline-block;
        }
        .editable {
            position: relative;
        }
        body.is-admin .editable:hover {
            outline: 2px dashed #ffb300;
        }
        
        body.is-admin .editable-text {
            outline: 1px dashed #ffb300;
            padding: 2px;
            border-radius: 3px;
            cursor: text;
        }
        body.is-admin .editable-text:hover {
            background: rgba(255, 179, 0, 0.2);
        }

        body.is-admin .grid-item {
            cursor: pointer;
        }
        body.is-admin .grid-item:hover::after {
            content: "Modifier image";
            position: absolute;
            top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.5);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            border-radius: 12px;
            pointer-events: none; 
        }

        .delete-btn {
            display: none;
            position: absolute;
            top: -10px;
            right: -10px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }
        body.is-admin .delete-btn {
            display: flex;
        }
        .delete-btn:hover { background: #c0392b; transform: scale(1.1); }

        /* BARRE FLOTTANTE ADMIN (Vue / Sauvegarde) - NOUVELLE VERSION AVEC BOUTON ROND */
        #admin-floating-wrapper {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 20px; /* Align√© en bas √† gauche */
            z-index: 9999;
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }
        body.admin-logged-in #admin-floating-wrapper {
            display: flex;
        }

        #admin-floating-toggle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary-green);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, background-color 0.2s;
        }
        #admin-floating-toggle:hover {
            transform: scale(1.1);
            background-color: #1b5e20;
        }

        #admin-floating-bar {
            display: none; /* Masqu√© par d√©faut, g√©r√© par JS lors du clic */
            background: #333;
            color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            flex-direction: column; /* Boutons en colonne pour la compacit√© */
            gap: 10px;
            align-items: stretch;
            text-align: center;
            margin-bottom: -5px;
        }

        .admin-action-btn {
            background: var(--primary-green);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }
        .admin-action-btn:hover { background: #1b5e20; }
        .admin-action-btn.secondary { background: #f39c12; }
        .admin-action-btn.secondary:hover { background: #e67e22; }

        /* =========================================
           ATELIER (COMMENTAIRES ET LIKES)
        ========================================= */
        .comments-section {
            display: none;
            margin-top: 15px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
        .comment-item {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 14px;
            position: relative;
        }
        .comment-input-container {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .comment-input-container input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .comment-input-container button {
            background: var(--primary-green);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        /* =========================================
           FOOTER
        ========================================= */
        footer {
            text-align: center;
            padding: 20px;
            background-color: #e0e0e0;
            font-style: italic;
            margin-top: auto;
        }

        /* =========================================
           MODALS (CONNEXION & CREATION)
        ========================================= */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 350px;
            text-align: center;
        }
        .modal-content input, .modal-content textarea {
            width: 100%;
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        #serveur-locked {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        /* Local chat styles */
        .local-chat {
            background: white;
            height: 350px;
            border-radius: 10px;
            padding: 12px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }
        .local-chat .message {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            background: #f5f5f5;
        }
        .local-chat .message .meta { font-size: 12px; color:#666; margin-bottom:6px; }
        .local-chat .reply { margin-top:8px; padding:8px; background:#fff; border-left: 3px solid #e0e0e0; border-radius:6px; }
        .local-chat .controls { display:flex; gap:8px; margin-top:10px; }
        .small-btn { padding:6px 10px; border-radius:6px; border:none; cursor:pointer; background:#ddd; }
        .small-btn:hover { opacity:0.9; }

        /* =========================================
           MODE MOBILE (RESPONSIVE) - CORRIG√â
        ========================================= */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 10px;
                padding: 15px 20px;
            }
            .header-top {
                display: flex;
                width: 100%;
                justify-content: space-between;
                align-items: center;
            }
            .logo-container {
                width: auto;
            }
            .hamburger {
                display: block; /* Affiche l'ic√¥ne de menu */
            }
            nav {
                width: 100%;
                display: none; /* Cache le menu par d√©faut */
                animation: fadeIn 0.3s ease;
            }
            nav.menu-open {
                display: block; /* Affiche le menu quand il a la classe menu-open */
            }
            nav ul {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
                padding-top: 15px;
            }
            nav a {
                display: block;
                text-align: center;
                padding: 12px;
                background: rgba(255,255,255,0.1);
                border-radius: 5px;
            }
            main {
                padding: 20px;
            }
            .accueil-layout {
                flex-direction: column;
                text-align: center;
                gap: 30px;
                margin-top: 20px;
            }
            .accueil-desc {
                max-width: 100%;
                font-size: 16px;
                margin: 0 auto;
            }
            .accueil-title {
                font-size: 45px; 
            }
            
            /* Syst√®me d'onglets pour publications */
            .mobile-pub-tabs {
                display: flex;
                justify-content: center;
                gap: 10px;
                margin-bottom: 20px;
            }
            .mobile-pub-tabs button {
                padding: 10px 15px;
                border: none;
                background: #ccc;
                color: #333;
                border-radius: 20px;
                font-weight: bold;
                cursor: pointer;
            }
            .mobile-pub-tabs button.active {
                background: var(--primary-green);
                color: white;
            }
            
            .publications-layout {
                grid-template-columns: 1fr; 
            }
            .publications-layout.show-travail #col-publi-wrap { display: none; }
            .publications-layout.show-travail #col-travail-wrap { display: block; }
            
            .publications-layout.show-publi #col-travail-wrap { display: none; }
            .publications-layout.show-publi #col-publi-wrap { display: block; }

            #galerie-container {
                grid-template-columns: repeat(2, 1fr) !important; 
            }
            .local-chat .controls {
                flex-direction: column;
            }
            .local-chat .controls button, .local-chat .controls input {
                width: 100%;
            }
            
            /* CORRECTION DU BUG ADMIN TOOLS SUR MOBILE */
            .admin-tools {
                display: none; /* Cache la bo√Æte de base */
            }
            body.is-admin .admin-tools {
                display: flex; /* L'affiche seulement si on est connect√© en admin */
                flex-direction: column;
                gap: 10px;
            }
            body.is-admin .admin-tools button {
                margin-left: 0 !important;
                width: 100%;
            }
            
            #admin-floating-wrapper {
                left: 10px; 
                bottom: 10px;
            }
            .modal-content {
                width: 90%;
            }
            .profile-pic {
                width: 120px;
                height: 120px;
            }
            .social-buttons {
                flex-direction: column;
                width: 100%;
                max-width: 300px;
            }
            .social-btn {
                text-align: center;
            }
            .comment-input-container {
                flex-direction: column;
            }
            .comment-input-container button {
                width: 100%;
            }
        }
    </style>
</head>
<body>

    <input type="file" id="globalFileInput" style="display:none;" accept="image/*,video/*" onchange="handleFileSelected(event)">
    <input type="color" id="globalColorPicker" style="display:none;" onchange="handleColorSelected(event)">

    <div id="admin-floating-wrapper">
        <div id="admin-floating-bar">
            <span style="font-size: 12px; margin-bottom: 5px;">üõ°Ô∏è Espace Admin</span>
            <button class="admin-action-btn secondary" id="toggleViewBtn" onclick="toggleAdminView()">üëÅÔ∏è Voir comme visiteur</button>
            <button class="admin-action-btn" id="saveGlobalBtn" onclick="saveAdminChanges()">üíæ Sauvegarder les modifs</button>
        </div>
        <button id="admin-floating-toggle" onclick="toggleAdminMenu()" title="Ouvrir le menu d'√©dition">‚úèÔ∏è</button>
    </div>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <h2>Connexion / Inscription</h2>
            <br>
            <input type="email" id="emailInput" placeholder="Adresse e-mail">
            <input type="password" id="passwordInput" placeholder="Mot de passe">
            <input type="text" id="usernameInput" placeholder="Nom d'utilisateur (visible)" style="display:block;" >
            <div style="display:flex; gap:8px; justify-content:center; margin-top:8px;">
                <button class="btn-connexion" onclick="attemptLogin()">Se connecter</button>
                <button class="btn-connexion" style="background:#0277bd;" onclick="attemptRegister()">S'inscrire</button>
            </div>
            <button class="btn-connexion" style="background:#ccc; margin-top:10px;" onclick="closeLogin()">Annuler</button>
            <p style="margin-top:8px; font-size:12px; color:#666;">Lors de l'inscription, le nom d'utilisateur sera affich√© publiquement.</p>
        </div>
    </div>

    <div id="createPostModal" class="modal">
        <div class="modal-content">
            <h2 id="createPostTitle">Nouvelle Publication</h2>
            <br>
            <textarea id="postText" rows="3" placeholder="Description..."></textarea>
            <button class="btn-connexion" style="background:#f39c12; margin-bottom:15px;" onclick="document.getElementById('postFileInput').click()">S√©lectionner Fichier (Image/Vid√©o)</button>
            <input type="file" id="postFileInput" style="display:none;" accept="image/*,video/*" onchange="previewPostFile(event)">
            
            <div id="postFilePreviewContainer" style="margin-bottom:15px; display:none;">
                <img id="postImagePreview" style="max-width:100%; border-radius:8px; display:none;">
                <video id="postVideoPreview" controls style="max-width:100%; border-radius:8px; display:none;"></video>
            </div>

            <button class="btn-connexion" onclick="submitPost()">Publier</button>
            <button class="btn-connexion" style="background:#ccc; margin-top:10px;" onclick="closeCreatePostModal()">Annuler</button>
        </div>
    </div>

    <header id="main-header">
        <div class="header-top">
            <div class="logo-container">
                <div class="logo-icon">M</div>
                <div class="logo-text">
                    <h1>Mosa√Øque</h1>
                    <p>Quand tout s'imbrique</p>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <button class="btn-connexion" id="authBtn" onclick="openLogin()">Connexion</button>
                <div class="hamburger" onclick="toggleMenu()">‚ò∞</div>
            </div>
        </div>
        <nav id="main-nav">
            <ul id="nav-links">
                <li><a onclick="showPage('accueil')" class="active" id="nav-accueil">Accueil</a></li>
                <li><a onclick="showPage('publications')" id="nav-publications">Publications</a></li>
                <li><a onclick="showPage('galerie')" id="nav-galerie">Galerie</a></li>
                <li><a onclick="showPage('atelier')" id="nav-atelier">Atelier</a></li>
                <li><a onclick="showPage('serveur')" id="nav-serveur">Serveur</a></li>
                <li><a onclick="showPage('apropos')" id="nav-apropos">A propos</a></li>
                <li id="nav-item-messages" style="display:none;"><a onclick="showPage('messages')" id="nav-messages">Messages üîî</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <div class="admin-tools">
            <strong>‚öôÔ∏è Mode √âdition activ√© :</strong> Cliquez sur n'importe quel texte pour le modifier. <b>Double-cliquez sur un texte pour changer sa couleur.</b><br><br>
            <button onclick="changeBgColor()">üé® Fond de page</button>
            <button onclick="changeBgImage()" style="margin-left:10px;">üñºÔ∏è Image de Fond</button>
            <button onclick="changeHeaderColor()" style="margin-left:10px;">üñåÔ∏è Couleur En-t√™te</button>
        </div>

        <section id="accueil" class="view-section active">
            <div class="accueil-layout">
                <div class="accueil-text editable">
                    <div class="badge editable-text" data-edit-id="accueil-badge">QUAND TOUT S'IMBRIQUE</div>
                    <h2 class="accueil-title editable-text" data-edit-id="accueil-title">Bienvenue</h2>
                    <p class="accueil-desc editable-text" data-edit-id="accueil-desc">
                        Un espace o√π chaque pi√®ce trouve sa place. D√©couvrez mes cr√©ations, mes citations et mon univers √† travers cette mosa√Øque de pens√©es et d'images.
                    </p>
                </div>
                <div class="accueil-grid editable" id="accueilGrid">
                    <div class="grid-item c1" data-edit-id="accueil-grid-1" onclick="triggerGridEdit(this)"><button class="delete-btn" onclick="deleteElement(event, this)" title="Supprimer">üóëÔ∏è</button></div>
                    <div class="grid-item c2" data-edit-id="accueil-grid-2" onclick="triggerGridEdit(this)"><button class="delete-btn" onclick="deleteElement(event, this)" title="Supprimer">üóëÔ∏è</button></div>
                    <div class="grid-item c3" data-edit-id="accueil-grid-3" onclick="triggerGridEdit(this)"><button class="delete-btn" onclick="deleteElement(event, this)" title="Supprimer">üóëÔ∏è</button></div>
                    <div class="grid-item c4" data-edit-id="accueil-grid-4" onclick="triggerGridEdit(this)"><button class="delete-btn" onclick="deleteElement(event, this)" title="Supprimer">üóëÔ∏è</button></div>
                    <div class="grid-item c5" data-edit-id="accueil-grid-5" onclick="triggerGridEdit(this)"><button class="delete-btn" onclick="deleteElement(event, this)" title="Supprimer">üóëÔ∏è</button></div>
                    <div class="grid-item c6" data-edit-id="accueil-grid-6" onclick="triggerGridEdit(this)"><button class="delete-btn" onclick="deleteElement(event, this)" title="Supprimer">üóëÔ∏è</button></div>
                    <div class="grid-item c7" data-edit-id="accueil-grid-7" onclick="triggerGridEdit(this)"><button class="delete-btn" onclick="deleteElement(event, this)" title="Supprimer">üóëÔ∏è</button></div>
                    <div class="grid-item c8" data-edit-id="accueil-grid-8" onclick="triggerGridEdit(this)"><button class="delete-btn" onclick="deleteElement(event, this)" title="Supprimer">üóëÔ∏è</button></div>
                    <div class="grid-item c9" data-edit-id="accueil-grid-9" onclick="triggerGridEdit(this)"><button class="delete-btn" onclick="deleteElement(event, this)" title="Supprimer">üóëÔ∏è</button></div>
                </div>
            </div>
        </section>

        <section id="publications" class="view-section">
            <div class="admin-tools">
                <button onclick="openCreatePostModal('travail')">+ Nouveau Travail en cours</button>
                <button onclick="openCreatePostModal('publication')">+ Nouvelle Publication</button>
            </div>
            
            <div class="mobile-pub-tabs">
                <button id="btn-tab-travail" class="active" onclick="switchPubTab('travail')">Travail en cours</button>
                <button id="btn-tab-publi" onclick="switchPubTab('publi')">Publications</button>
            </div>

            <div class="publications-layout show-travail" id="pub-layout">
                <div id="col-travail-wrap">
                    <h3 class="col-title editable-text" data-edit-id="col-travail-title">Travail en cours</h3>
                    <div id="travail-container">
                    </div>
                </div>
                <div id="col-publi-wrap">
                    <h3 class="col-title editable-text" data-edit-id="col-publi-title">Publications</h3>
                    <div id="publication-container">
                    </div>
                </div>
            </div>
        </section>

        <section id="galerie" class="view-section">
            <div class="admin-tools">
                <button onclick="openCreatePostModal('galerie')">+ Ajouter Photo/Vid√©o</button>
            </div>
            <h2 class="editable-text" data-edit-id="galerie-title" style="margin-bottom: 20px;">Ma Galerie</h2>
            <div id="galerie-container" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:15px;">
                </div>
        </section>

        <section id="atelier" class="view-section">
            <div class="admin-tools">
                <button onclick="openCreatePostModal('atelier')">+ Poster dans l'Atelier</button>
            </div>
            <h2 class="editable-text" data-edit-id="atelier-title" style="margin-bottom: 20px;">L'Atelier (Espace d'√©change)</h2>
            <p class="editable-text" data-edit-id="atelier-desc">Connectez-vous pour liker ou commenter les cr√©ations.</p>
            <div id="atelier-container">
                </div>
        </section>

        <section id="serveur" class="view-section">
            <div id="serveur-locked" style="display:none;">
                <h2 style="margin-bottom: 15px;">üîí Acc√®s R√©serv√©</h2>
                <p style="margin-bottom: 20px;">Vous devez √™tre connect√© ou cr√©er un compte pour acc√©der au serveur de discussion et √©changer avec la communaut√©.</p>
                <button class="btn-connexion" onclick="openLogin()">Se connecter / S'inscrire</button>
            </div>

            <div id="serveur-unlocked" style="display: block;">
                <h2 class="editable-text" data-edit-id="serveur-title" style="margin-bottom: 20px;">Serveur de discussion</h2>

                <div class="local-chat" id="localChatContainer" aria-live="polite"></div>

                <div class="controls" style="display:flex; gap:10px; margin-top:10px;">
                    <input type="text" id="localMessageInput" placeholder="√âcrire un message..." style="flex:1; padding:10px; border:1px solid #ddd; border-radius:5px;">
                    <button class="btn-connexion" id="sendLocalBtn">Envoyer</button>
                    <button class="btn-connexion" style="background:#0277bd;" id="setLocalNameBtn">Nom</button>
                    <button class="btn-connexion" style="background:#ccc;" id="clearLocalBtn">Effacer tout</button>
                </div>
                <p style="margin-top:8px; font-size:13px; color:#666;">Chat stock√© localement (sinon utilisez la messagerie de contact pour messages administratifs).</p>
            </div>
        </section>

        <section id="apropos" class="view-section">
            <div class="apropos-container editable">
                <img src="https://via.placeholder.com/150" alt="Photo de profil" class="profile-pic" id="profilePic">
                <button class="edit-btn" onclick="triggerProfilePicEdit()">Modifier la photo (Fichier local)</button>
                <h2 class="editable-text" data-edit-id="apropos-title">√Ä propos de moi</h2>
                <p style="max-width: 600px; margin: 20px 0;" class="editable-text" data-edit-id="apropos-desc">
                    Bienvenue dans mon univers. Ici, chaque pi√®ce trouve sa place...
                </p>
                
                <div class="social-buttons">
                    <a href="https://instagram.com" target="_blank" class="social-btn btn-insta" onclick="editSocialLink(event, this)">Instagram</a>
                    <a href="https://facebook.com" target="_blank" class="social-btn btn-fb" onclick="editSocialLink(event, this)">Facebook</a>
                    <a href="https://tiktok.com" target="_blank" class="social-btn btn-tiktok" onclick="editSocialLink(event, this)">TikTok</a>
                </div>

                <h3>Me contacter en priv√©</h3>
                <form class="contact-form" onsubmit="submitContactForm(event)">
                    <input type="text" id="contactName" placeholder="Votre Nom" required>
                    <input type="email" id="contactEmail" placeholder="Votre Email" required>
                    <textarea id="contactMessage" rows="5" placeholder="Votre message..." required></textarea>
                    <button type="submit">Envoyer le message</button>
                </form>
            </div>
        </section>

        <section id="messages" class="view-section">
            <h2 style="margin-bottom: 20px; font-family: var(--font-title);">üì• Bo√Æte de r√©ception</h2>
            <p style="margin-bottom: 20px; color:#666;">Retrouvez ici tous les messages envoy√©s depuis le formulaire de contact (vue admin) ou vos messages re√ßus (vue utilisateur).</p>
            <div id="messages-container" style="display: flex; flex-direction: column; gap: 15px;">
                </div>
        </section>

    </main>

    <footer>
        <span class="editable-text" id="footer-quote" data-edit-id="footer-quote" style="display:inline-block;">"La cr√©ativit√©, c'est l'intelligence qui s'amuse."</span>
    </footer>

    <script type="module">
        // IMPORT FIREBASE via CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-analytics.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            query, 
            orderBy,
            doc,
            setDoc,
            getDoc,
            onSnapshot,
            updateDoc,
            arrayUnion,
            arrayRemove,
            deleteDoc,
            where
        } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        // CONFIGURATION FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyDDPZXeNClGSxaD9Y5kthokz8yyEcWSFMI",
            authDomain: "mosa-12196.firebaseapp.com",
            projectId: "mosa-12196",
            storageBucket: "mosa-12196.firebasestorage.app",
            messagingSenderId: "169487101407",
            appId: "1:169487101407:web:da4ebd17251e44f8d9e86a",
            measurementId: "G-8PWBB20SND"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Variables de session
        window.userRole = 'guest';
        window.isEditMode = false;
        window.currentUserEmail = null;
        window.currentUsername = null;

        // --- GESTION DE LA NAVIGATION ---
        window.toggleMenu = function() {
            const nav = document.getElementById('main-nav');
            if(nav) nav.classList.toggle('menu-open');
        };

        window.showPage = function(pageId) {
            document.querySelectorAll('.view-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('nav a').forEach(link => {
                link.classList.remove('active');
            });

            document.getElementById(pageId).classList.add('active');
            if(document.getElementById('nav-' + pageId)) {
                document.getElementById('nav-' + pageId).classList.add('active');
            }

            // Fermer le menu sur mobile quand on change de page
            const nav = document.getElementById('main-nav');
            if(nav) nav.classList.remove('menu-open');

            if(pageId === 'serveur') {
                document.getElementById('serveur-locked').style.display = 'none';
                document.getElementById('serveur-unlocked').style.display = 'block';
                renderLocalChat();
            }
        };

        window.switchPubTab = function(tab) {
            const layout = document.getElementById('pub-layout');
            const btnTravail = document.getElementById('btn-tab-travail');
            const btnPubli = document.getElementById('btn-tab-publi');
            
            if (tab === 'travail') {
                layout.classList.add('show-travail');
                layout.classList.remove('show-publi');
                btnTravail.classList.add('active');
                btnPubli.classList.remove('active');
            } else {
                layout.classList.add('show-publi');
                layout.classList.remove('show-travail');
                btnPubli.classList.add('active');
                btnTravail.classList.remove('active');
            }
        };

        // --- NOUVELLE FONCTION POUR LE MENU FLOTTANT ADMIN ---
        window.toggleAdminMenu = function() {
            const menu = document.getElementById('admin-floating-bar');
            if (menu.style.display === 'flex') {
                menu.style.display = 'none';
            } else {
                menu.style.display = 'flex';
            }
        };

        // --- ECOUTEUR D'ETAT D'AUTHENTIFICATION ---
        let adminMessagesUnsubscribe = null;
        let userInboxesUnsubscribe = null;
        let postsUnsub = null;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                window.currentUserEmail = user.email;
                try {
                    const userDocRef = doc(db, "users", user.email);
                    const userSnap = await getDoc(userDocRef);
                    if(userSnap.exists()) {
                        const u = userSnap.data();
                        window.currentUsername = u.username || user.email;
                    } else {
                        window.currentUsername = (user.email && user.email.split('@')[0]) || user.email;
                    }
                } catch(e) {
                    window.currentUsername = (user.email && user.email.split('@')[0]) || user.email;
                }

                if (user.email === "karl.renard.28@gmail.com") {
                    enableAdminMode();
                    if(adminMessagesUnsubscribe) adminMessagesUnsubscribe();
                    adminMessagesUnsubscribe = loadAdminMessagesRealtime();
                } else {
                    enableUserMode();
                    if(userInboxesUnsubscribe) userInboxesUnsubscribe();
                    userInboxesUnsubscribe = loadUserInboxesRealtime(user.email);
                }
            } else {
                window.userRole = 'guest';
                window.currentUserEmail = null;
                window.currentUsername = null;
                if(adminMessagesUnsubscribe) adminMessagesUnsubscribe();
                if(userInboxesUnsubscribe) userInboxesUnsubscribe();
                document.getElementById('nav-item-messages').style.display = 'none';
                document.getElementById('authBtn').innerText = "Connexion";
                document.getElementById('authBtn').onclick = openLogin;
            }
            updateAuthButtonUI();
        });

        // --- GESTION DES MODALS ET CONNEXION ---
        window.openLogin = function() { 
            const localName = localStorage.getItem('mosaic_local_name') || '';
            document.getElementById('usernameInput').value = localName;
            document.getElementById('loginModal').style.display = 'flex'; 
        };
        window.closeLogin = function() { document.getElementById('loginModal').style.display = 'none'; };

        window.attemptLogin = function() {
            const email = document.getElementById('emailInput').value;
            const pass = document.getElementById('passwordInput').value;
            
            signInWithEmailAndPassword(auth, email, pass)
                .then((userCredential) => {
                    alert("Connect√© avec succ√®s.");
                    closeLogin();
                })
                .catch((error) => {
                    alert("Erreur de connexion : " + error.message);
                });
        };

        window.attemptRegister = async function() {
            const email = document.getElementById('emailInput').value;
            const pass = document.getElementById('passwordInput').value;
            const username = (document.getElementById('usernameInput').value || "").trim();
            if(!email || !pass || !username) { alert("Veuillez remplir les champs (y compris le nom d'utilisateur)."); return; }
            
            try {
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                await setDoc(doc(db, "users", email), { username: username, createdAt: new Date() });
                alert("Compte cr√©√© avec succ√®s ! Bienvenue " + username + " !");
                closeLogin();
            } catch (error) {
                alert("Erreur lors de l'inscription : " + error.message);
            }
        };

        function updateAuthButtonUI() {
            const btn = document.getElementById('authBtn');
            if(window.currentUsername) {
                btn.innerText = `D√©connexion (${window.currentUsername})`;
                btn.onclick = logout;
            } else if(window.currentUserEmail) {
                btn.innerText = `D√©connexion (${window.currentUserEmail})`;
                btn.onclick = logout;
            } else {
                btn.innerText = "Connexion";
                btn.onclick = openLogin;
            }
        }

        window.enableAdminMode = function() {
            window.userRole = 'admin';
            window.isEditMode = true;
            document.body.classList.add('admin-logged-in'); 
            document.body.classList.add('is-admin'); 
            document.getElementById('authBtn').innerText = "D√©connexion";
            document.getElementById('authBtn').onclick = logout;
            document.getElementById('nav-item-messages').style.display = 'block';
            activateEditableTexts();
            closeLogin();
            if(document.getElementById('serveur').classList.contains('active')) showPage('serveur');
        };

        window.enableUserMode = function() {
            window.userRole = 'user';
            document.body.classList.remove('admin-logged-in');
            document.body.classList.remove('is-admin');
            document.getElementById('authBtn').innerText = "D√©connexion";
            document.getElementById('authBtn').onclick = logout;
            document.getElementById('nav-item-messages').style.display = 'none';
            if(document.getElementById('messages').classList.contains('active')) showPage('accueil');
            deactivateEditableTexts();
            closeLogin();
            if(document.getElementById('serveur').classList.contains('active')) showPage('serveur');
        };

        window.logout = function() {
            signOut(auth).then(() => {
                window.userRole = 'guest';
                window.isEditMode = false;
                document.body.classList.remove('admin-logged-in');
                document.body.classList.remove('is-admin');
                document.getElementById('authBtn').innerText = "Connexion";
                document.getElementById('authBtn').onclick = openLogin;
                document.getElementById('nav-item-messages').style.display = 'none';
                if(document.getElementById('messages').classList.contains('active')) showPage('accueil');
                deactivateEditableTexts();
                
                // Cacher le menu flottant s'il √©tait ouvert
                document.getElementById('admin-floating-bar').style.display = 'none';
                
                alert("D√©connect√©.");
                if(document.getElementById('serveur').classList.contains('active')) showPage('serveur');
            }).catch((error) => {
                alert("Erreur lors de la d√©connexion : " + error.message);
            });
        };

        function activateEditableTexts() {
            document.querySelectorAll('.editable-text').forEach(el => {
                el.contentEditable = "true";
                el.title = "Double-cliquez pour changer la couleur du texte";
                el.ondblclick = function() {
                    openColorPicker((color) => { el.style.color = color; });
                };
            });
        }

        function deactivateEditableTexts() {
            document.querySelectorAll('.editable-text').forEach(el => {
                el.contentEditable = "false";
                el.title = "";
                el.ondblclick = null;
            });
        }

        window.toggleAdminView = function() {
            window.isEditMode = !window.isEditMode;
            const btn = document.getElementById('toggleViewBtn');
            if(window.isEditMode) {
                document.body.classList.add('is-admin');
                btn.innerText = "üëÅÔ∏è Voir comme visiteur";
                activateEditableTexts();
            } else {
                document.body.classList.remove('is-admin');
                btn.innerText = "‚úèÔ∏è Mode √âdition";
                deactivateEditableTexts();
            }
        };

        window.submitContactForm = async function(event) {
            event.preventDefault();
            const btn = event.target.querySelector('button');
            const originalText = btn.innerText;
            btn.innerText = "Envoi en cours...";
            btn.disabled = true;

            try {
                const newMsgRef = await addDoc(collection(db, "messages"), {
                    nom: document.getElementById('contactName').value,
                    email: document.getElementById('contactEmail').value,
                    message: document.getElementById('contactMessage').value,
                    date: new Date(),
                    replies: []
                });
                alert("Votre message a bien √©t√© envoy√© !");
                event.target.reset(); 
            } catch (e) {
                console.error("Erreur d'envoi", e);
                alert("Erreur lors de l'envoi : " + e.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        };

        window.saveAdminChanges = async function() {
            const btn = document.getElementById('saveGlobalBtn');
            btn.innerText = "‚è≥ Sauvegarde...";
            btn.disabled = true;

            const CLOUD_NAME = "db1qtttwr";
            const UPLOAD_PRESET = "ml_default";

            try {
                const uploadIfBase64 = async (srcOrBg) => {
                    if (srcOrBg && srcOrBg.includes('data:image')) {
                        const match = srcOrBg.match(/url\(['"]?(data:image[^'"]+)['"]?\)/);
                        const base64Data = match ? match[1] : (srcOrBg.startsWith('data:image') ? srcOrBg : null);
                        
                        if (base64Data) {
                            const formData = new FormData();
                            formData.append('file', base64Data);
                            formData.append('upload_preset', UPLOAD_PRESET);
                            const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`, {
                                method: 'POST', body: formData
                            });
                            const data = await res.json();
                            return data.secure_url;
                        }
                    }
                    return srcOrBg; 
                };

                const profilePic = document.getElementById('profilePic');
                if(profilePic.src.startsWith('data:image')) {
                    profilePic.src = await uploadIfBase64(profilePic.src);
                }
                
                let bodyBg = document.body.style.backgroundImage;
                if(bodyBg && bodyBg.includes('data:image')) {
                    const newUrl = await uploadIfBase64(bodyBg);
                    document.body.style.backgroundImage = `url(${newUrl})`;
                }

                const gridsToSave = {};
                const gridItems = document.querySelectorAll('.grid-item');
                for(let el of gridItems) {
                    if(el.dataset.editId) {
                        let bg = el.style.backgroundImage;
                        if(bg && bg.includes('data:image')) {
                            const newUrl = await uploadIfBase64(bg);
                            el.style.backgroundImage = `url(${newUrl})`;
                        }
                        gridsToSave[el.dataset.editId] = el.style.backgroundImage;
                    }
                }

                const textsToSave = {};
                document.querySelectorAll('.editable-text').forEach(el => {
                    if(el.dataset.editId) {
                        textsToSave[el.dataset.editId] = {
                            html: el.innerHTML,
                            color: el.style.color
                        };
                    }
                });

                const configData = {
                    texts: textsToSave,
                    styles: {
                        bodyBgColor: document.body.style.backgroundColor,
                        bodyBgImage: document.body.style.backgroundImage,
                        headerBgColor: document.documentElement.style.getPropertyValue('--header-bg')
                    },
                    images: { profilePic: profilePic.src },
                    grids: gridsToSave,
                    updatedAt: new Date()
                };

                await setDoc(doc(db, "config", "main"), configData);
                alert("‚úÖ Toutes les modifications ont √©t√© sauvegard√©es en ligne !");
            } catch(e) {
                console.error("Erreur de sauvegarde:", e);
                alert("Erreur lors de la sauvegarde : " + e.message);
            } finally {
                btn.innerText = "üíæ Sauvegarder les modifs";
                btn.disabled = false;
            }
        };

        function loadSiteConfigRealtime() {
            onSnapshot(doc(db, "config", "main"), (docSnap) => {
                if(docSnap.exists()) {
                    const data = docSnap.data();
                    if(data.texts) {
                        Object.keys(data.texts).forEach(id => {
                            const el = document.querySelector(`[data-edit-id="${id}"]`);
                            if(el && document.activeElement !== el) {
                                el.innerHTML = data.texts[id].html;
                                if(data.texts[id].color) el.style.color = data.texts[id].color;
                            }
                        });
                    }
                    if(data.styles) {
                        if(data.styles.bodyBgColor) document.body.style.backgroundColor = data.styles.bodyBgColor;
                        if(data.styles.bodyBgImage) document.body.style.backgroundImage = data.styles.bodyBgImage;
                        if(data.styles.headerBgColor) document.documentElement.style.setProperty('--header-bg', data.styles.headerBgColor);
                    }
                    if(data.images && data.images.profilePic) {
                        document.getElementById('profilePic').src = data.images.profilePic;
                    }
                    if(data.grids) {
                        Object.keys(data.grids).forEach(id => {
                            const el = document.querySelector(`[data-edit-id="${id}"]`);
                            if(el && data.grids[id] && data.grids[id] !== "none") {
                                el.style.backgroundImage = data.grids[id];
                                el.style.backgroundSize = "cover";
                                el.style.backgroundPosition = "center";
                            }
                        });
                    }
                }
            });
        }

        let fileCallback = null;
        let colorCallback = null;

        window.openFilePicker = function(callback) {
            fileCallback = callback;
            document.getElementById('globalFileInput').click();
        };

        window.handleFileSelected = function(event) {
            const file = event.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                if(fileCallback) fileCallback(e.target.result, file.type);
                document.getElementById('globalFileInput').value = ""; 
            };
            reader.readAsDataURL(file);
        };

        window.openColorPicker = function(callback) {
            colorCallback = callback;
            document.getElementById('globalColorPicker').click();
        };

        window.handleColorSelected = function(event) {
            if(colorCallback) colorCallback(event.target.value);
        };

        window.changeBgColor = function() {
            openColorPicker((color) => {
                document.body.style.backgroundImage = "none";
                document.body.style.backgroundColor = color;
            });
        };

        window.changeBgImage = function() {
            openFilePicker((dataUrl) => {
                document.body.style.backgroundImage = `url(${dataUrl})`;
                document.body.style.backgroundSize = "cover";
                document.body.style.backgroundAttachment = "fixed";
            });
        };

        window.changeHeaderColor = function() {
            openColorPicker((color) => {
                document.documentElement.style.setProperty('--header-bg', color);
            });
        };

        window.deleteElement = function(event, btnElement) {
            event.stopPropagation(); 
            if(confirm("Voulez-vous vraiment supprimer cet √©l√©ment ?")) {
                btnElement.parentElement.remove();
            }
        };

        window.editSocialLink = function(event, linkElement) {
            if(window.userRole === 'admin' && window.isEditMode) {
                event.preventDefault(); 
                const newUrl = prompt(`Modifier le lien pour ${linkElement.innerText} :`, linkElement.href);
                if(newUrl) {
                    linkElement.href = newUrl;
                }
            }
        };

        window.triggerProfilePicEdit = function() {
            if(!window.isEditMode) return;
            openFilePicker((dataUrl) => {
                document.getElementById('profilePic').src = dataUrl;
            });
        };

        window.triggerGridEdit = function(element) {
            if(window.userRole !== 'admin' || !window.isEditMode) return;
            openFilePicker((dataUrl) => {
                element.style.backgroundImage = `url(${dataUrl})`;
                element.style.backgroundSize = "cover";
                element.style.backgroundPosition = "center";
                element.style.backgroundColor = "transparent";
            });
        };

        window.toggleLike = async function(btn, postId) {
            if(window.userRole === 'guest') { alert("Connecte-toi pour liker !"); return; }
            try {
                const postRef = doc(db, "posts", postId);
                const postSnap = await getDoc(postRef);
                if(!postSnap.exists()) return;
                const postData = postSnap.data();
                const userEmail = window.currentUserEmail || "inconnu";
                const likesBy = postData.likesBy || [];
                if(likesBy.includes(userEmail)) {
                    await updateDoc(postRef, { likesBy: arrayRemove(userEmail) });
                } else {
                    await updateDoc(postRef, { likesBy: arrayUnion(userEmail) });
                }
            } catch(e) {
                console.error("Erreur toggleLike:", e);
                alert("Erreur lors du like : " + e.message);
            }
        };

        window.toggleCommentSection = function(btn) {
            let section = btn.parentElement.nextElementSibling;
            if(section.style.display === 'none' || section.style.display === '') {
                section.style.display = 'block';
            } else {
                section.style.display = 'none';
            }
        };

        window.addComment = async function(btn, postId) {
            if(window.userRole === 'guest') { alert("Connecte-toi pour commenter !"); return; }
            let container = btn.parentElement;
            let input = container.querySelector('input');
            let text = input.value.trim();
            if(text === '') return;
            
            try {
                const postRef = doc(db, "posts", postId);
                const commentObj = { author: window.currentUsername || window.currentUserEmail || "Utilisateur", text: text, date: new Date() };
                await updateDoc(postRef, { comments: arrayUnion(commentObj) });
                input.value = '';
            } catch(e) {
                console.error("Erreur addComment:", e);
                alert("Erreur lors de l'ajout du commentaire : " + e.message);
            }
        };

        window.handleCommentEnter = function(event, input, postId) {
            if(event.key === 'Enter') {
                addComment(input.nextElementSibling, postId);
            }
        };

        let currentPostTarget = "";
        let currentPostFileData = ""; 
        let currentPostFileType = "";

        window.openCreatePostModal = function(target) {
            currentPostTarget = target;
            const titles = {
                'travail': 'Nouveau Travail en cours',
                'publication': 'Nouvelle Publication',
                'galerie': 'Ajouter √† la Galerie',
                'atelier': 'Poster dans l\'Atelier'
            };
            document.getElementById('createPostTitle').innerText = titles[target];
            
            document.getElementById('postText').value = "";
            document.getElementById('postFileInput').value = "";
            currentPostFileData = "";
            currentPostFileType = "";
            document.getElementById('postFilePreviewContainer').style.display = "none";
            document.getElementById('postImagePreview').style.display = "none";
            document.getElementById('postVideoPreview').style.display = "none";
            
            document.getElementById('postText').style.display = (target === 'galerie') ? 'none' : 'block';
            document.getElementById('createPostModal').style.display = 'flex';
        };

        window.closeCreatePostModal = function() {
            document.getElementById('createPostModal').style.display = 'none';
        };

        window.previewPostFile = function(event) {
            const file = event.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                currentPostFileData = e.target.result;
                currentPostFileType = file.type;
                
                document.getElementById('postFilePreviewContainer').style.display = "block";
                const imgPreview = document.getElementById('postImagePreview');
                const vidPreview = document.getElementById('postVideoPreview');

                if(file.type.startsWith('image/')) {
                    imgPreview.src = currentPostFileData;
                    imgPreview.style.display = "block";
                    vidPreview.style.display = "none";
                } else if(file.type.startsWith('video/')) {
                    vidPreview.src = currentPostFileData;
                    vidPreview.style.display = "block";
                    imgPreview.style.display = "none";
                }
            };
            reader.readAsDataURL(file);
        };

        window.submitPost = async function() {
            const text = document.getElementById('postText').value;
            const CLOUD_NAME = "db1qtttwr";
            const UPLOAD_PRESET = "ml_default";

            if(!currentPostFileData && currentPostTarget === 'galerie') {
                alert("Veuillez s√©lectionner un fichier.");
                return;
            }

            try {
                let mediaUrl = "";
                const titleElement = document.getElementById('createPostTitle');
                
                if (currentPostFileData) {
                    titleElement.innerText = "Envoi du fichier vers Cloudinary... ‚è≥";
                    const formData = new FormData();
                    formData.append('file', currentPostFileData);
                    formData.append('upload_preset', UPLOAD_PRESET);

                    const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`, {
                        method: 'POST', body: formData
                    });

                    const data = await response.json();
                    if (data.secure_url) {
                        mediaUrl = data.secure_url;
                    } else {
                        throw new Error(data.error ? data.error.message : "Erreur inconnue Cloudinary");
                    }
                }

                titleElement.innerText = "Enregistrement du post dans Firebase... ‚è≥";

                await addDoc(collection(db, "posts"), {
                    texte: text,
                    media: mediaUrl, 
                    type: currentPostFileType,
                    cible: currentPostTarget,
                    date: new Date(),
                    author: window.currentUsername || window.currentUserEmail || 'Anonyme',
                    likesBy: [],
                    comments: []
                });

                alert("Post publi√© avec succ√®s !");
                closeCreatePostModal();
            } catch (e) {
                console.error("Erreur lors de la publication : ", e);
                alert("Une erreur est survenue : " + e.message);
                document.getElementById('createPostTitle').innerText = "Nouvelle Publication";
            }
        };

        window.afficherPostSurInterface = function(postId, data) {
            const text = data.texte || "";
            const fileData = data.media || "";
            const fileType = data.type || "";
            const target = data.cible;
            const likesBy = data.likesBy || [];
            const comments = data.comments || [];
            const author = data.author || (data.auteur || '');

            let mediaHTML = "";
            if(fileData) {
                if(fileType && fileType.startsWith('image/')) {
                    mediaHTML = `<img src="${fileData}" style="width:100%; border-radius:8px; margin-top:10px;">`;
                } else if(fileType && fileType.startsWith('video/')) {
                    mediaHTML = `<video src="${fileData}" controls style="width:100%; border-radius:8px; margin-top:10px;"></video>`;
                }
            }

            if(target === 'galerie') {
                const newGridItem = document.createElement('div');
                newGridItem.className = 'grid-item editable';
                newGridItem.style.backgroundImage = `url(${fileData})`;
                newGridItem.style.backgroundSize = "cover";
                newGridItem.style.backgroundPosition = "center";
                newGridItem.onclick = function() { triggerGridEdit(this); };
                newGridItem.innerHTML = `<button class="delete-btn" onclick="deleteElement(event, this)" title="Supprimer">üóëÔ∏è</button>`;
                
                const container = document.getElementById('galerie-container');
                if(container) container.prepend(newGridItem);
            } 
            else {
                let commentsHTML = '';
                if(comments.length > 0) {
                    comments.forEach(c => {
                        const dateStr = c.date && c.date.toDate ? c.date.toDate().toLocaleString('fr-FR') : (c.date ? new Date(c.date).toLocaleString('fr-FR') : '');
                        commentsHTML += `<div class="comment-item"><strong>${c.author} :</strong> ${c.text} <br><small style="color:#888;">${dateStr}</small></div>`;
                    });
                }

                const postHTML = `
                    <div class="post-card" data-post-id="${postId}">
                        <button class="delete-btn" onclick="deleteElement(event, this)" title="Supprimer">üóëÔ∏è</button>
                        <p class="editable-text" contenteditable="false" title="Double-cliquez pour changer la couleur du texte" ondblclick="openColorPicker((color) => { this.style.color = color; })">${text}</p>
                        ${mediaHTML}
                        <div style="margin-top: 10px; border-top: 1px solid #eee; padding-top:10px;">
                            <div style="font-size:13px; color:#666; margin-bottom:8px;">Publi√© par <strong>${author}</strong></div>
                            <button onclick="toggleLike(this, '${postId}')" style="background:none; border:none; color:var(--primary-green); cursor:pointer; font-weight:bold;">
                                ‚ù§Ô∏è <span class="like-count">${likesBy.length}</span> Likes
                            </button>
                            <button onclick="toggleCommentSection(this)" style="background:none; border:none; color:var(--primary-green); cursor:pointer; margin-left:15px; font-weight:bold;">üí¨ Commenter</button>
                        </div>
                        <div class="comments-section">
                            <div class="comments-list">
                                ${commentsHTML}
                            </div>
                            <div class="comment-input-container">
                                <input type="text" placeholder="Ajouter un commentaire..." onkeypress="handleCommentEnter(event, this, '${postId}')">
                                <button onclick="addComment(this, '${postId}')">Envoyer</button>
                            </div>
                        </div>
                    </div>
                `;
                
                const containerId = target + "-container";
                const container = document.getElementById(containerId);
                if(container) container.insertAdjacentHTML('afterbegin', postHTML);
            }
        };

        function loadPostsRealtime() {
            const q = query(collection(db, "posts"), orderBy("date", "asc"));
            return onSnapshot(q, (snapshot) => {
                document.getElementById('travail-container').innerHTML = '';
                document.getElementById('publication-container').innerHTML = '';
                document.getElementById('atelier-container').innerHTML = '';
                document.getElementById('galerie-container').innerHTML = '';
                
                snapshot.forEach((docSnap) => {
                    afficherPostSurInterface(docSnap.id, docSnap.data());
                });
            });
        }

        function loadAdminMessagesRealtime() {
            const q = query(collection(db, "messages"), orderBy("date", "desc"));
            const unsubscribe = onSnapshot(q, (snapshot) => {
                const container = document.getElementById('messages-container');
                container.innerHTML = ''; 
                
                if(snapshot.empty) {
                    container.innerHTML = '<p>Aucun message pour le moment.</p>';
                    return;
                }

                snapshot.forEach((docSnap) => {
                    const msg = docSnap.data();
                    const dateStr = msg.date ? (msg.date.toDate ? msg.date.toDate().toLocaleString('fr-FR') : new Date(msg.date).toLocaleString('fr-FR')) : '';
                    const replies = msg.replies || [];

                    let repliesHTML = '';
                    replies.forEach(r => {
                        const rDate = r.date && r.date.toDate ? r.date.toDate().toLocaleString('fr-FR') : (r.date ? new Date(r.date).toLocaleString('fr-FR') : '');
                        repliesHTML += `<div style="margin-top:8px; padding:8px; background:#f3f3f3; border-radius:6px;"><strong>${r.author} :</strong> ${r.text} <br><small style="color:#888">${rDate}</small></div>`;
                    });

                    const msgHTML = `
                        <div class="post-card" style="border-left: 4px solid var(--primary-green);" data-message-id="${docSnap.id}">
                            <strong>üë§ De :</strong> ${msg.nom} (<a href="mailto:${msg.email}">${msg.email}</a>) <br>
                            <small style="color: #888;">üìÖ Le ${dateStr}</small>
                            <div style="margin-top:15px; padding-top:15px; border-top:1px solid #eee; white-space: pre-wrap;">${msg.message}</div>
                            ${repliesHTML}
                            <div style="margin-top:12px; display:flex; gap:8px;">
                                <button class="btn-connexion" onclick="replyToMessage('${docSnap.id}', '${msg.email}')">R√©pondre</button>
                                <button class="btn-connexion" style="background:#e74c3c;" onclick="adminDeleteMessage('${docSnap.id}')">Supprimer</button>
                            </div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', msgHTML);
                });
            });
            return unsubscribe;
        }

        window.replyToMessage = async function(messageDocId, recipientEmail) {
            if(window.userRole !== 'admin') { alert("Seul l'admin peut r√©pondre."); return; }
            const replyText = prompt("√âcrire la r√©ponse pour l'utilisateur ("+recipientEmail+") :");
            if(!replyText) return;
            try {
                const msgRef = doc(db, "messages", messageDocId);
                const replyObj = { author: "Administrateur", text: replyText, date: new Date() };
                await updateDoc(msgRef, { replies: arrayUnion(replyObj) });

                await addDoc(collection(db, "inboxes"), {
                    recipientEmail: recipientEmail,
                    messageId: messageDocId,
                    from: "admin",
                    text: replyText,
                    date: new Date(),
                    visible: true,
                    read: false
                });
                alert("R√©ponse envoy√©e et sauvegard√©e. L'utilisateur verra un onglet 'Messages' temporaire.");
            } catch(e) {
                console.error("Erreur replyToMessage:", e);
                alert("Erreur lors de l'envoi de la r√©ponse : " + e.message);
            }
        };

        window.adminDeleteMessage = async function(messageDocId) {
            if(!confirm("Confirmer la suppression d√©finitive de ce message (et des notifications associ√©es) ?")) return;
            try {
                await deleteDoc(doc(db, "messages", messageDocId));
                const q = query(collection(db, "inboxes"), where("messageId", "==", messageDocId));
                const snaps = await getDocs(q);
                const deletions = [];
                snaps.forEach(s => {
                    deletions.push(deleteDoc(doc(db, "inboxes", s.id)));
                });
                await Promise.all(deletions);
                alert("Message et notifications associ√©es supprim√©s.");
            } catch(e) {
                console.error("Erreur adminDeleteMessage:", e);
                alert("Erreur lors de la suppression : " + e.message);
            }
        };

        function loadUserInboxesRealtime(userEmail) {
            const q = query(collection(db, "inboxes"), where("recipientEmail", "==", userEmail), where("visible", "==", true), orderBy("date", "desc"));
            const unsubscribe = onSnapshot(q, (snapshot) => {
                const container = document.getElementById('messages-container');
                if(!snapshot.empty) {
                    document.getElementById('nav-item-messages').style.display = 'block';
                } else {
                    document.getElementById('nav-item-messages').style.display = 'none';
                    if(document.getElementById('messages').classList.contains('active')) showPage('accueil');
                }
                container.innerHTML = '';
                if(snapshot.empty) {
                    container.innerHTML = '<p>Vous n\'avez aucun message.</p>';
                    return;
                }
                snapshot.forEach((docSnap) => {
                    const m = docSnap.data();
                    const dateStr = m.date ? (m.date.toDate ? m.date.toDate().toLocaleString('fr-FR') : new Date(m.date).toLocaleString('fr-FR')) : '';
                    const inboxHTML = `
                        <div class="post-card" style="border-left: 4px solid var(--primary-green);" data-inbox-id="${docSnap.id}">
                            <strong>üì© Message de l'admin</strong> <br>
                            <small style="color:#888;">Le ${dateStr}</small>
                            <div style="margin-top:12px; white-space:pre-wrap;">${m.text}</div>
                            <div style="margin-top:10px;">
                                <button class="btn-connexion" onclick="markInboxRead('${docSnap.id}')">Marquer lu</button>
                                <button class="btn-connexion" style="background:#e74c3c;" onclick="hideInbox('${docSnap.id}')">Fermer</button>
                            </div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', inboxHTML);
                });
            });
            return unsubscribe;
        }

        window.markInboxRead = async function(inboxId) {
            try {
                await updateDoc(doc(db, "inboxes", inboxId), { read: true });
                alert("Marqu√© comme lu.");
            } catch(e) { console.error(e); alert("Erreur."); }
        };

        window.hideInbox = async function(inboxId) {
            try {
                await updateDoc(doc(db, "inboxes", inboxId), { visible: false });
                alert("Message ferm√©.");
            } catch(e) { console.error(e); alert("Erreur."); }
        };

        const LOCAL_CHAT_KEY = 'mosaic_local_chat';
        const LOCAL_NAME_KEY = 'mosaic_local_name';

        function loadLocalMessages() {
            try {
                const raw = localStorage.getItem(LOCAL_CHAT_KEY);
                if(!raw) return [];
                return JSON.parse(raw);
            } catch(e) {
                return [];
            }
        }

        function saveLocalMessages(messages) {
            localStorage.setItem(LOCAL_CHAT_KEY, JSON.stringify(messages));
        }

        function renderLocalChat() {
            const container = document.getElementById('localChatContainer');
            const messages = loadLocalMessages();
            container.innerHTML = '';
            if(messages.length === 0) {
                container.innerHTML = '<p style="color:#666;">Aucun message pour l\'instant. √âcrivez le premier message !</p>';
                return;
            }
            messages.forEach(msg => {
                const el = document.createElement('div');
                el.className = 'message';
                const date = msg.date ? new Date(msg.date).toLocaleString('fr-FR') : '';
                const metaName = msg.username || msg.authorName || (msg.email || 'Anonyme');
                el.innerHTML = `
                    <div class="meta"><strong>${escapeHtml(metaName)}</strong> ‚Ä¢ <small>${escapeHtml(date)}</small></div>
                    <div class="body">${escapeHtml(msg.text)}</div>
                    <div class="replies"></div>
                    <div class="controls" style="margin-top:8px;">
                        <button class="small-btn" onclick="replyLocalMessage('${msg.id}')">R√©pondre</button>
                        <button class="small-btn" onclick="quoteLocalMessage('${msg.id}')">Citer</button>
                        ${window.userRole === 'admin' ? `<button class="small-btn" style="background:#e74c3c;color:white;" onclick="deleteLocalMessage('${msg.id}')">Supprimer</button>` : ''}
                    </div>
                `;
                const repliesEl = el.querySelector('.replies');
                (msg.replies || []).forEach(r => {
                    const rEl = document.createElement('div');
                    rEl.className = 'reply';
                    const rDate = r.date ? new Date(r.date).toLocaleString('fr-FR') : '';
                    const rAuthor = r.username || r.authorName || r.from || 'Anonyme';
                    rEl.innerHTML = `<div style="font-size:12px;color:#666;"><strong>${escapeHtml(rAuthor)}</strong> ‚Ä¢ <small>${escapeHtml(rDate)}</small></div><div style="margin-top:4px;">${escapeHtml(r.text)}</div>`;
                    repliesEl.appendChild(rEl);
                });
                container.appendChild(el);
            });
            container.scrollTop = container.scrollHeight;
        }

        function escapeHtml(str) {
            if(!str && str !== 0) return '';
            return String(str)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#039;');
        }

        function sendLocalChatMessage() {
            const input = document.getElementById('localMessageInput');
            const text = input.value.trim();
            if(!text) return;
            const messages = loadLocalMessages();
            const id = Date.now().toString(36) + Math.random().toString(36).slice(2,8);
            const username = window.currentUsername || localStorage.getItem(LOCAL_NAME_KEY) || promptForLocalName();
            const email = window.currentUserEmail || null;
            const msg = {
                id,
                username,
                authorName: username,
                email,
                text,
                date: new Date().toISOString(),
                replies: []
            };
            messages.push(msg);
            saveLocalMessages(messages);
            input.value = '';
            renderLocalChat();
        }

        window.replyLocalMessage = function(messageId) {
            const text = prompt("√âcrire une r√©ponse publique :");
            if(!text) return;
            const messages = loadLocalMessages();
            const idx = messages.findIndex(m => m.id === messageId);
            if(idx === -1) { alert("Message introuvable."); return; }
            const username = window.currentUsername || localStorage.getItem(LOCAL_NAME_KEY) || promptForLocalName();
            const reply = {
                id: Date.now().toString(36) + Math.random().toString(36).slice(2,8),
                username,
                text,
                date: new Date().toISOString()
            };
            messages[idx].replies = messages[idx].replies || [];
            messages[idx].replies.push(reply);
            saveLocalMessages(messages);
            renderLocalChat();
        };

        window.quoteLocalMessage = function(messageId) {
            const messages = loadLocalMessages();
            const m = messages.find(x => x.id === messageId);
            if(!m) return;
            const input = document.getElementById('localMessageInput');
            input.value = `@${m.username || 'Anonyme'}: "${m.text}" `;
            input.focus();
        };

        window.deleteLocalMessage = function(messageId) {
            if(!confirm("Confirmer la suppression du message local ?")) return;
            let messages = loadLocalMessages();
            messages = messages.filter(m => m.id !== messageId);
            saveLocalMessages(messages);
            renderLocalChat();
        };

        function clearAllLocal() {
            if(!confirm("Effacer tous les messages locaux ?")) return;
            localStorage.removeItem(LOCAL_CHAT_KEY);
            renderLocalChat();
        }

        function promptForLocalName() {
            const existing = localStorage.getItem(LOCAL_NAME_KEY);
            if(existing) return existing;
            const name = prompt("Choisissez un nom d'affichage pour le chat (visible) :");
            if(name && name.trim()) {
                localStorage.setItem(LOCAL_NAME_KEY, name.trim());
                return name.trim();
            }
            return "Anonyme";
        }

        document.addEventListener('click', (e) => {
            const sendBtn = document.getElementById('sendLocalBtn');
            if(sendBtn && e.target === sendBtn) sendLocalChatMessage();
            const setBtn = document.getElementById('setLocalNameBtn');
            if(setBtn && e.target === setBtn) {
                const name = prompt("Nom d'affichage local :", localStorage.getItem(LOCAL_NAME_KEY) || '');
                if(name && name.trim()) {
                    localStorage.setItem(LOCAL_NAME_KEY, name.trim());
                    alert("Nom d'affichage enregistr√© : " + name.trim());
                    renderLocalChat();
                }
            }
            const clearBtn = document.getElementById('clearLocalBtn');
            if(clearBtn && e.target === clearBtn) clearAllLocal();
        });

        document.getElementById('localMessageInput').addEventListener('keydown', function(e){
            if(e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendLocalChatMessage();
            }
        });

        function initApp() {
            loadSiteConfigRealtime(); 
            window.postsUnsub = loadPostsRealtime();
            renderLocalChat();
        }

        initApp();

    </script>
</body>
</html>
